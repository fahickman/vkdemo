/*
This is free and unencumbered software released into the public domain.

Anyone is free to copy, modify, publish, use, compile, sell, or
distribute this software, either in source code form or as a compiled
binary, for any purpose, commercial or non-commercial, and by any
means.

In jurisdictions that recognize copyright laws, the author or authors
of this software dedicate any and all copyright interest in the
software to the public domain. We make this dedication for the benefit
of the public at large and to the detriment of our heirs and
successors. We intend this dedication to be an overt act of
relinquishment in perpetuity of all present and future rights to this
software under copyright law.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR
OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
OTHER DEALINGS IN THE SOFTWARE.
*/

#include <math.h>
#include <stdlib.h>
#include <string.h>

#include "vkdemo.h"

#define PI 3.14159265f
#define CUBE_SPIN_SPEED    0.5f // turns per second

typedef struct VulkanFramebuffer {
   VkImageView    view;
   VkFramebuffer  framebuffer;
} VulkanFramebuffer;

typedef struct DemoResources {
   VulkanFramebuffer *framebuffers;
   VkRenderPass renderPass;
   VkShaderModule vertexShader;
   VkShaderModule fragmentShader;
   VkPipelineLayout pipelineLayout;
   VkPipeline pipeline;
} DemoResources;

typedef struct Vec3 {
   float x, y, z;
} Vec3;

typedef struct Vec4 {
   float x, y, z, w;
} Vec4;

typedef struct Mat4 {
   Vec4 m[4];
} Mat4;

typedef struct ShaderMatrices {
   Mat4 clipFromLocal;
} ShaderMatrices;

static DemoResources s_resources;
static uint32_t s_frameNum;
static float s_cubeRot;       // in turns

static inline Vec3 vec3Add(Vec3 a, Vec3 b)
{
   Vec3 r;

   r.x = a.x + b.x;
   r.y = a.y + b.y;
   r.z = a.z + b.z;

   return r;
}

static inline Vec3 vec3Sub(Vec3 a, Vec3 b)
{
   Vec3 r;

   r.x = a.x - b.x;
   r.y = a.y - b.y;
   r.z = a.z - b.z;

   return r;
}

static inline Vec3 vec3Scale(Vec3 a, float b)
{
   Vec3 r;

   r.x = a.x * b;
   r.y = a.y * b;
   r.z = a.z * b;

   return r;
}

static inline float vec3Dot(Vec3 a, Vec3 b)
{
   return a.x * b.x + a.y * b.y + a.z * b.z;
}

static inline Vec3 vec3Normalize(Vec3 v)
{
   float lensq = vec3Dot(v, v);
   return vec3Scale(v, 1.0f / sqrtf(lensq));
}

static inline Vec3 vec3Cross(Vec3 a, Vec3 b)
{
   Vec3 r;

   r.x = a.y * b.z - a.z * b.y;
   r.y = a.z * b.x - a.x * b.z;
   r.z = a.x * b.y - a.y * b.x;

   return r;
}

static void mat4RotY(Mat4 *m, float angle)
{
   float c = cosf(angle);
   float s = sinf(angle);

   m->m[0].x = c;
   m->m[0].y = 0.0f;
   m->m[0].z = s;
   m->m[0].w = 0.0f;

   m->m[1].x = 0.0f;
   m->m[1].y = 1.0f;
   m->m[1].z = 0.0f;
   m->m[1].w = 0.0f;

   m->m[2].x = -s;
   m->m[2].y = 0.0f;
   m->m[2].z = c;
   m->m[2].w = 0.0f;

   m->m[3].x = 0.0f;
   m->m[3].y = 0.0f;
   m->m[3].z = 0.0f;
   m->m[3].w = 1.0f;
}

static void mat4Mul(Mat4 *r, const Mat4 *a, const Mat4 *b)
{
   Mat4 tmp;

   tmp.m[0].x = a->m[0].x * b->m[0].x + a->m[1].x * b->m[0].y + a->m[2].x * b->m[0].z + a->m[3].x * b->m[0].w;
   tmp.m[0].y = a->m[0].y * b->m[0].x + a->m[1].y * b->m[0].y + a->m[2].y * b->m[0].z + a->m[3].y * b->m[0].w;
   tmp.m[0].z = a->m[0].z * b->m[0].x + a->m[1].z * b->m[0].y + a->m[2].z * b->m[0].z + a->m[3].z * b->m[0].w;
   tmp.m[0].w = a->m[0].w * b->m[0].x + a->m[1].w * b->m[0].y + a->m[2].w * b->m[0].z + a->m[3].w * b->m[0].w;

   tmp.m[1].x = a->m[0].x * b->m[1].x + a->m[1].x * b->m[1].y + a->m[2].x * b->m[1].z + a->m[3].x * b->m[1].w;
   tmp.m[1].y = a->m[0].y * b->m[1].x + a->m[1].y * b->m[1].y + a->m[2].y * b->m[1].z + a->m[3].y * b->m[1].w;
   tmp.m[1].z = a->m[0].z * b->m[1].x + a->m[1].z * b->m[1].y + a->m[2].z * b->m[1].z + a->m[3].z * b->m[1].w;
   tmp.m[1].w = a->m[0].w * b->m[1].x + a->m[1].w * b->m[1].y + a->m[2].w * b->m[1].z + a->m[3].w * b->m[1].w;

   tmp.m[2].x = a->m[0].x * b->m[2].x + a->m[1].x * b->m[2].y + a->m[2].x * b->m[2].z + a->m[3].x * b->m[2].w;
   tmp.m[2].y = a->m[0].y * b->m[2].x + a->m[1].y * b->m[2].y + a->m[2].y * b->m[2].z + a->m[3].y * b->m[2].w;
   tmp.m[2].z = a->m[0].z * b->m[2].x + a->m[1].z * b->m[2].y + a->m[2].z * b->m[2].z + a->m[3].z * b->m[2].w;
   tmp.m[2].w = a->m[0].w * b->m[2].x + a->m[1].w * b->m[2].y + a->m[2].w * b->m[2].z + a->m[3].w * b->m[2].w;

   tmp.m[3].x = a->m[0].x * b->m[3].x + a->m[1].x * b->m[3].y + a->m[2].x * b->m[3].z + a->m[3].x * b->m[3].w;
   tmp.m[3].y = a->m[0].y * b->m[3].x + a->m[1].y * b->m[3].y + a->m[2].y * b->m[3].z + a->m[3].y * b->m[3].w;
   tmp.m[3].z = a->m[0].z * b->m[3].x + a->m[1].z * b->m[3].y + a->m[2].z * b->m[3].z + a->m[3].z * b->m[3].w;
   tmp.m[3].w = a->m[0].w * b->m[3].x + a->m[1].w * b->m[3].y + a->m[2].w * b->m[3].z + a->m[3].w * b->m[3].w;

   memcpy(r, &tmp, sizeof(tmp));
}

static inline void mat4PerspectiveFov(Mat4 *r, float fovY, float aspect, float nearDist, float farDist)
{
   float y = tanf(fovY * 0.5f);
   float x = aspect * y;

   float hw = x * nearDist;
   float hh = y * nearDist;
   float c, d;

   if (nearDist < farDist) {
      c = nearDist / (nearDist - farDist);
      d = -farDist * nearDist / (nearDist - farDist);
   } else {
      c = 0.0f;
      d = nearDist;
   }

   r->m[0].x = 1.0f / x;
   r->m[0].y = 0.0f;
   r->m[0].z = 0.0f;
   r->m[0].w = 0.0f;

   r->m[1].x = 0.0f;
   r->m[1].y = 1.0f / y;
   r->m[1].z = 0.0f;
   r->m[1].w = 0.0f;

   r->m[2].x = 0.0f;
   r->m[2].y = 0.0f;
   r->m[2].z = c;
   r->m[2].w = 1.0f;

   r->m[3].x = 0.0f;
   r->m[3].y = 0.0f;
   r->m[3].z = d;
   r->m[3].w = 0.0f;
}

static inline void mat4LookAt(Mat4 *r, Vec3 eye, Vec3 target, Vec3 up)
{
   Vec3 mf = vec3Normalize(vec3Sub(target, eye));
   Vec3 mr = vec3Normalize(vec3Cross(up, mf));
   Vec3 mu = vec3Cross(mr, mf);

   r->m[0].x = mr.x;
   r->m[0].y = mr.y;
   r->m[0].z = mr.z;
   r->m[0].w = 0.0f;

   r->m[1].x = mu.x;
   r->m[1].y = mu.y;
   r->m[1].z = mu.z;
   r->m[1].w = 0.0f;

   r->m[2].x = mf.x;
   r->m[2].y = mf.y;
   r->m[2].z = mf.z;
   r->m[2].w = 0.0f;

   r->m[3].x = -eye.x * mr.x - eye.y * mu.x - eye.z * mf.x;
   r->m[3].y = -eye.x * mr.y - eye.y * mu.y - eye.z * mf.y;
   r->m[3].z = -eye.x * mr.z - eye.y * mu.z - eye.z * mf.z;
   r->m[3].w = 1.0f;
}

int InitResources(const VulkanDevice *device)
{
   // create render pass
   {
      VkAttachmentDescription attachmentDesc = {
         .flags = 0,
         .format = device->surfaceFormat,
         .samples = VK_SAMPLE_COUNT_1_BIT,
         .loadOp = VK_ATTACHMENT_LOAD_OP_CLEAR,
         .storeOp = VK_ATTACHMENT_STORE_OP_STORE,
         .stencilLoadOp = VK_ATTACHMENT_LOAD_OP_DONT_CARE,
         .stencilStoreOp = VK_ATTACHMENT_STORE_OP_DONT_CARE,
         .initialLayout = VK_IMAGE_LAYOUT_UNDEFINED,
         .finalLayout = VK_IMAGE_LAYOUT_PRESENT_SRC_KHR,
      };

      VkAttachmentReference attachmentRef = {
         .attachment = 0,
         .layout = VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL,
      };

      VkSubpassDescription subpass = {
         .flags = 0,
         .pipelineBindPoint = VK_PIPELINE_BIND_POINT_GRAPHICS,
         .inputAttachmentCount = 0,
         .pInputAttachments = NULL,
         .colorAttachmentCount = 1,
         .pColorAttachments = &attachmentRef,
         .pResolveAttachments = NULL,
         .pResolveAttachments = NULL,
         .pDepthStencilAttachment = NULL,
         .preserveAttachmentCount = 0,
         .pPreserveAttachments = NULL,
      };

      VkRenderPassCreateInfo passCreateInfo = {
         .sType = VK_STRUCTURE_TYPE_RENDER_PASS_CREATE_INFO,
         .pNext = NULL,
         .flags = 0,
         .attachmentCount = 1,
         .pAttachments = &attachmentDesc,
         .subpassCount = 1,
         .pSubpasses = &subpass,
         .dependencyCount = 0,
         .pDependencies = NULL,
      };
      VK_VERIFY(device->vkCreateRenderPass(device->device, &passCreateInfo, NULL, &s_resources.renderPass));
   }

   // create frame buffers
   s_resources.framebuffers = malloc(sizeof(*s_resources.framebuffers) * device->swapchainImageCount);
   for (uint32_t i = 0; i < device->swapchainImageCount; ++i) {
      VkImageViewCreateInfo imageViewCreateInfo = {
         .sType = VK_STRUCTURE_TYPE_IMAGE_VIEW_CREATE_INFO,
         .pNext = NULL,
         .flags = 0,
         .image = device->swapchainImages[i],
         .viewType = VK_IMAGE_VIEW_TYPE_2D,
         .format = device->surfaceFormat,
         .components = {
            .r = VK_COMPONENT_SWIZZLE_R,
            .g = VK_COMPONENT_SWIZZLE_G,
            .b = VK_COMPONENT_SWIZZLE_B,
            .a = VK_COMPONENT_SWIZZLE_A
         },
         .subresourceRange = {
            .aspectMask = VK_IMAGE_ASPECT_COLOR_BIT,
            .baseMipLevel = 0,
            .levelCount = 1,
            .baseArrayLayer = 0,
            .layerCount = 1
         },
      };
      VK_VERIFY(device->vkCreateImageView(device->device, &imageViewCreateInfo, NULL, &s_resources.framebuffers[i].view));

      VkFramebufferCreateInfo framebufferCreateInfo = {
         .sType = VK_STRUCTURE_TYPE_FRAMEBUFFER_CREATE_INFO,
         .pNext = NULL,
         .flags = 0,
         .renderPass = s_resources.renderPass,
         .attachmentCount = 1,
         .pAttachments = &s_resources.framebuffers[i].view,
         .width = device->surfaceWidth,
         .height = device->surfaceHeight,
         .layers = 1,
      };
      VK_VERIFY(device->vkCreateFramebuffer(device->device, &framebufferCreateInfo, NULL, &s_resources.framebuffers[i].framebuffer));
   }
   
   // create pipeline
   {
      static const uint8_t g_vertexShaderCode[] = {
         0x03, 0x02, 0x23, 0x07, 0x00, 0x00, 0x01, 0x00, 0x06, 0x00, 0x08, 0x00,
         0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x00, 0x02, 0x00,
         0x01, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x06, 0x00, 0x01, 0x00, 0x00, 0x00,
         0x47, 0x4c, 0x53, 0x4c, 0x2e, 0x73, 0x74, 0x64, 0x2e, 0x34, 0x35, 0x30,
         0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
         0x01, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,
         0x04, 0x00, 0x00, 0x00, 0x6d, 0x61, 0x69, 0x6e, 0x00, 0x00, 0x00, 0x00,
         0x16, 0x00, 0x00, 0x00, 0x33, 0x00, 0x00, 0x00, 0x45, 0x00, 0x00, 0x00,
         0x03, 0x00, 0x03, 0x00, 0x02, 0x00, 0x00, 0x00, 0x90, 0x01, 0x00, 0x00,
         0x04, 0x00, 0x09, 0x00, 0x47, 0x4c, 0x5f, 0x41, 0x52, 0x42, 0x5f, 0x73,
         0x65, 0x70, 0x61, 0x72, 0x61, 0x74, 0x65, 0x5f, 0x73, 0x68, 0x61, 0x64,
         0x65, 0x72, 0x5f, 0x6f, 0x62, 0x6a, 0x65, 0x63, 0x74, 0x73, 0x00, 0x00,
         0x04, 0x00, 0x09, 0x00, 0x47, 0x4c, 0x5f, 0x41, 0x52, 0x42, 0x5f, 0x73,
         0x68, 0x61, 0x64, 0x69, 0x6e, 0x67, 0x5f, 0x6c, 0x61, 0x6e, 0x67, 0x75,
         0x61, 0x67, 0x65, 0x5f, 0x34, 0x32, 0x30, 0x70, 0x61, 0x63, 0x6b, 0x00,
         0x05, 0x00, 0x04, 0x00, 0x04, 0x00, 0x00, 0x00, 0x6d, 0x61, 0x69, 0x6e,
         0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x04, 0x00, 0x08, 0x00, 0x00, 0x00,
         0x69, 0x6e, 0x64, 0x65, 0x78, 0x00, 0x00, 0x00, 0x05, 0x00, 0x06, 0x00,
         0x16, 0x00, 0x00, 0x00, 0x67, 0x6c, 0x5f, 0x56, 0x65, 0x72, 0x74, 0x65,
         0x78, 0x49, 0x6e, 0x64, 0x65, 0x78, 0x00, 0x00, 0x05, 0x00, 0x05, 0x00,
         0x19, 0x00, 0x00, 0x00, 0x69, 0x6e, 0x64, 0x65, 0x78, 0x61, 0x62, 0x6c,
         0x65, 0x00, 0x00, 0x00, 0x05, 0x00, 0x05, 0x00, 0x1f, 0x00, 0x00, 0x00,
         0x6c, 0x6f, 0x63, 0x61, 0x6c, 0x50, 0x6f, 0x73, 0x00, 0x00, 0x00, 0x00,
         0x05, 0x00, 0x05, 0x00, 0x2f, 0x00, 0x00, 0x00, 0x69, 0x6e, 0x64, 0x65,
         0x78, 0x61, 0x62, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x05, 0x00, 0x04, 0x00,
         0x33, 0x00, 0x00, 0x00, 0x76, 0x43, 0x6f, 0x6c, 0x6f, 0x72, 0x00, 0x00,
         0x05, 0x00, 0x05, 0x00, 0x3e, 0x00, 0x00, 0x00, 0x69, 0x6e, 0x64, 0x65,
         0x78, 0x61, 0x62, 0x6c, 0x65, 0x00, 0x00, 0x00, 0x05, 0x00, 0x06, 0x00,
         0x43, 0x00, 0x00, 0x00, 0x67, 0x6c, 0x5f, 0x50, 0x65, 0x72, 0x56, 0x65,
         0x72, 0x74, 0x65, 0x78, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x06, 0x00,
         0x43, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x67, 0x6c, 0x5f, 0x50,
         0x6f, 0x73, 0x69, 0x74, 0x69, 0x6f, 0x6e, 0x00, 0x06, 0x00, 0x07, 0x00,
         0x43, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x67, 0x6c, 0x5f, 0x50,
         0x6f, 0x69, 0x6e, 0x74, 0x53, 0x69, 0x7a, 0x65, 0x00, 0x00, 0x00, 0x00,
         0x06, 0x00, 0x07, 0x00, 0x43, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
         0x67, 0x6c, 0x5f, 0x43, 0x6c, 0x69, 0x70, 0x44, 0x69, 0x73, 0x74, 0x61,
         0x6e, 0x63, 0x65, 0x00, 0x05, 0x00, 0x03, 0x00, 0x45, 0x00, 0x00, 0x00,
         0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x05, 0x00, 0x47, 0x00, 0x00, 0x00,
         0x4d, 0x61, 0x74, 0x72, 0x69, 0x63, 0x65, 0x73, 0x00, 0x00, 0x00, 0x00,
         0x06, 0x00, 0x07, 0x00, 0x47, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
         0x63, 0x6c, 0x69, 0x70, 0x46, 0x72, 0x6f, 0x6d, 0x4c, 0x6f, 0x63, 0x61,
         0x6c, 0x00, 0x00, 0x00, 0x05, 0x00, 0x05, 0x00, 0x49, 0x00, 0x00, 0x00,
         0x6d, 0x61, 0x74, 0x72, 0x69, 0x63, 0x65, 0x73, 0x00, 0x00, 0x00, 0x00,
         0x47, 0x00, 0x04, 0x00, 0x16, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00,
         0x2a, 0x00, 0x00, 0x00, 0x47, 0x00, 0x04, 0x00, 0x33, 0x00, 0x00, 0x00,
         0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x48, 0x00, 0x05, 0x00,
         0x43, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00,
         0x00, 0x00, 0x00, 0x00, 0x48, 0x00, 0x05, 0x00, 0x43, 0x00, 0x00, 0x00,
         0x01, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
         0x48, 0x00, 0x05, 0x00, 0x43, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
         0x0b, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x47, 0x00, 0x03, 0x00,
         0x43, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x48, 0x00, 0x04, 0x00,
         0x47, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
         0x48, 0x00, 0x05, 0x00, 0x47, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
         0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x48, 0x00, 0x05, 0x00,
         0x47, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
         0x10, 0x00, 0x00, 0x00, 0x47, 0x00, 0x03, 0x00, 0x47, 0x00, 0x00, 0x00,
         0x02, 0x00, 0x00, 0x00, 0x13, 0x00, 0x02, 0x00, 0x02, 0x00, 0x00, 0x00,
         0x21, 0x00, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
         0x15, 0x00, 0x04, 0x00, 0x06, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00,
         0x01, 0x00, 0x00, 0x00, 0x20, 0x00, 0x04, 0x00, 0x07, 0x00, 0x00, 0x00,
         0x07, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x15, 0x00, 0x04, 0x00,
         0x09, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
         0x2b, 0x00, 0x04, 0x00, 0x09, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00,
         0x24, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x04, 0x00, 0x0b, 0x00, 0x00, 0x00,
         0x06, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x2b, 0x00, 0x04, 0x00,
         0x06, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
         0x2b, 0x00, 0x04, 0x00, 0x06, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00,
         0x00, 0x00, 0x00, 0x00, 0x2b, 0x00, 0x04, 0x00, 0x06, 0x00, 0x00, 0x00,
         0x0e, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x2b, 0x00, 0x04, 0x00,
         0x06, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
         0x2b, 0x00, 0x04, 0x00, 0x06, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
         0x05, 0x00, 0x00, 0x00, 0x2b, 0x00, 0x04, 0x00, 0x06, 0x00, 0x00, 0x00,
         0x11, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x2b, 0x00, 0x04, 0x00,
         0x06, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00,
         0x2b, 0x00, 0x04, 0x00, 0x06, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00,
         0x06, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x27, 0x00, 0x0b, 0x00, 0x00, 0x00,
         0x14, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00,
         0x0e, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00,
         0x0f, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
         0x0f, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00,
         0x11, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
         0x11, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00,
         0x13, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00,
         0x13, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00,
         0x0e, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00,
         0x0f, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00,
         0x0e, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00,
         0x0d, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
         0x12, 0x00, 0x00, 0x00, 0x20, 0x00, 0x04, 0x00, 0x15, 0x00, 0x00, 0x00,
         0x01, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x3b, 0x00, 0x04, 0x00,
         0x15, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
         0x20, 0x00, 0x04, 0x00, 0x18, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
         0x0b, 0x00, 0x00, 0x00, 0x16, 0x00, 0x03, 0x00, 0x1c, 0x00, 0x00, 0x00,
         0x20, 0x00, 0x00, 0x00, 0x17, 0x00, 0x04, 0x00, 0x1d, 0x00, 0x00, 0x00,
         0x1c, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x20, 0x00, 0x04, 0x00,
         0x1e, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x1d, 0x00, 0x00, 0x00,
         0x2b, 0x00, 0x04, 0x00, 0x09, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00,
         0x08, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x04, 0x00, 0x21, 0x00, 0x00, 0x00,
         0x1d, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x2b, 0x00, 0x04, 0x00,
         0x1c, 0x00, 0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xbf,
         0x2b, 0x00, 0x04, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00,
         0x00, 0x00, 0x80, 0x3f, 0x2c, 0x00, 0x07, 0x00, 0x1d, 0x00, 0x00, 0x00,
         0x24, 0x00, 0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x22, 0x00, 0x00, 0x00,
         0x22, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x07, 0x00,
         0x1d, 0x00, 0x00, 0x00, 0x25, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00,
         0x22, 0x00, 0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00,
         0x2c, 0x00, 0x07, 0x00, 0x1d, 0x00, 0x00, 0x00, 0x26, 0x00, 0x00, 0x00,
         0x22, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x22, 0x00, 0x00, 0x00,
         0x23, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x07, 0x00, 0x1d, 0x00, 0x00, 0x00,
         0x27, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00,
         0x22, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x07, 0x00,
         0x1d, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x22, 0x00, 0x00, 0x00,
         0x22, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00,
         0x2c, 0x00, 0x07, 0x00, 0x1d, 0x00, 0x00, 0x00, 0x29, 0x00, 0x00, 0x00,
         0x23, 0x00, 0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00,
         0x23, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x07, 0x00, 0x1d, 0x00, 0x00, 0x00,
         0x2a, 0x00, 0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00,
         0x23, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x07, 0x00,
         0x1d, 0x00, 0x00, 0x00, 0x2b, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00,
         0x23, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00,
         0x2c, 0x00, 0x0b, 0x00, 0x21, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x00, 0x00,
         0x24, 0x00, 0x00, 0x00, 0x25, 0x00, 0x00, 0x00, 0x26, 0x00, 0x00, 0x00,
         0x27, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x29, 0x00, 0x00, 0x00,
         0x2a, 0x00, 0x00, 0x00, 0x2b, 0x00, 0x00, 0x00, 0x20, 0x00, 0x04, 0x00,
         0x2e, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x21, 0x00, 0x00, 0x00,
         0x20, 0x00, 0x04, 0x00, 0x32, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
         0x1d, 0x00, 0x00, 0x00, 0x3b, 0x00, 0x04, 0x00, 0x32, 0x00, 0x00, 0x00,
         0x33, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x2b, 0x00, 0x04, 0x00,
         0x1c, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
         0x2c, 0x00, 0x07, 0x00, 0x1d, 0x00, 0x00, 0x00, 0x35, 0x00, 0x00, 0x00,
         0x34, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00,
         0x23, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x07, 0x00, 0x1d, 0x00, 0x00, 0x00,
         0x36, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00,
         0x34, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x07, 0x00,
         0x1d, 0x00, 0x00, 0x00, 0x37, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00,
         0x23, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00,
         0x2c, 0x00, 0x07, 0x00, 0x1d, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00,
         0x23, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00,
         0x23, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x07, 0x00, 0x1d, 0x00, 0x00, 0x00,
         0x39, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00,
         0x23, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x07, 0x00,
         0x1d, 0x00, 0x00, 0x00, 0x3a, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00,
         0x34, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00,
         0x2c, 0x00, 0x07, 0x00, 0x1d, 0x00, 0x00, 0x00, 0x3b, 0x00, 0x00, 0x00,
         0x34, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x00,
         0x23, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x0b, 0x00, 0x21, 0x00, 0x00, 0x00,
         0x3c, 0x00, 0x00, 0x00, 0x35, 0x00, 0x00, 0x00, 0x36, 0x00, 0x00, 0x00,
         0x37, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00, 0x39, 0x00, 0x00, 0x00,
         0x3a, 0x00, 0x00, 0x00, 0x3b, 0x00, 0x00, 0x00, 0x2b, 0x00, 0x00, 0x00,
         0x2b, 0x00, 0x04, 0x00, 0x09, 0x00, 0x00, 0x00, 0x41, 0x00, 0x00, 0x00,
         0x01, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x04, 0x00, 0x42, 0x00, 0x00, 0x00,
         0x1c, 0x00, 0x00, 0x00, 0x41, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x05, 0x00,
         0x43, 0x00, 0x00, 0x00, 0x1d, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00,
         0x42, 0x00, 0x00, 0x00, 0x20, 0x00, 0x04, 0x00, 0x44, 0x00, 0x00, 0x00,
         0x03, 0x00, 0x00, 0x00, 0x43, 0x00, 0x00, 0x00, 0x3b, 0x00, 0x04, 0x00,
         0x44, 0x00, 0x00, 0x00, 0x45, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
         0x18, 0x00, 0x04, 0x00, 0x46, 0x00, 0x00, 0x00, 0x1d, 0x00, 0x00, 0x00,
         0x04, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x03, 0x00, 0x47, 0x00, 0x00, 0x00,
         0x46, 0x00, 0x00, 0x00, 0x20, 0x00, 0x04, 0x00, 0x48, 0x00, 0x00, 0x00,
         0x09, 0x00, 0x00, 0x00, 0x47, 0x00, 0x00, 0x00, 0x3b, 0x00, 0x04, 0x00,
         0x48, 0x00, 0x00, 0x00, 0x49, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
         0x20, 0x00, 0x04, 0x00, 0x4a, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00,
         0x46, 0x00, 0x00, 0x00, 0x36, 0x00, 0x05, 0x00, 0x02, 0x00, 0x00, 0x00,
         0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
         0xf8, 0x00, 0x02, 0x00, 0x05, 0x00, 0x00, 0x00, 0x3b, 0x00, 0x04, 0x00,
         0x07, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
         0x3b, 0x00, 0x04, 0x00, 0x18, 0x00, 0x00, 0x00, 0x19, 0x00, 0x00, 0x00,
         0x07, 0x00, 0x00, 0x00, 0x3b, 0x00, 0x04, 0x00, 0x1e, 0x00, 0x00, 0x00,
         0x1f, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x3b, 0x00, 0x04, 0x00,
         0x2e, 0x00, 0x00, 0x00, 0x2f, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
         0x3b, 0x00, 0x04, 0x00, 0x2e, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00,
         0x07, 0x00, 0x00, 0x00, 0x3d, 0x00, 0x04, 0x00, 0x06, 0x00, 0x00, 0x00,
         0x17, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x03, 0x00,
         0x19, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x41, 0x00, 0x05, 0x00,
         0x07, 0x00, 0x00, 0x00, 0x1a, 0x00, 0x00, 0x00, 0x19, 0x00, 0x00, 0x00,
         0x17, 0x00, 0x00, 0x00, 0x3d, 0x00, 0x04, 0x00, 0x06, 0x00, 0x00, 0x00,
         0x1b, 0x00, 0x00, 0x00, 0x1a, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x03, 0x00,
         0x08, 0x00, 0x00, 0x00, 0x1b, 0x00, 0x00, 0x00, 0x3d, 0x00, 0x04, 0x00,
         0x06, 0x00, 0x00, 0x00, 0x2d, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
         0x3e, 0x00, 0x03, 0x00, 0x2f, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x00, 0x00,
         0x41, 0x00, 0x05, 0x00, 0x1e, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00,
         0x2f, 0x00, 0x00, 0x00, 0x2d, 0x00, 0x00, 0x00, 0x3d, 0x00, 0x04, 0x00,
         0x1d, 0x00, 0x00, 0x00, 0x31, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00,
         0x3e, 0x00, 0x03, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x31, 0x00, 0x00, 0x00,
         0x3d, 0x00, 0x04, 0x00, 0x06, 0x00, 0x00, 0x00, 0x3d, 0x00, 0x00, 0x00,
         0x08, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x03, 0x00, 0x3e, 0x00, 0x00, 0x00,
         0x3c, 0x00, 0x00, 0x00, 0x41, 0x00, 0x05, 0x00, 0x1e, 0x00, 0x00, 0x00,
         0x3f, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 0x3d, 0x00, 0x00, 0x00,
         0x3d, 0x00, 0x04, 0x00, 0x1d, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00,
         0x3f, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x03, 0x00, 0x33, 0x00, 0x00, 0x00,
         0x40, 0x00, 0x00, 0x00, 0x41, 0x00, 0x05, 0x00, 0x4a, 0x00, 0x00, 0x00,
         0x4b, 0x00, 0x00, 0x00, 0x49, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00,
         0x3d, 0x00, 0x04, 0x00, 0x46, 0x00, 0x00, 0x00, 0x4c, 0x00, 0x00, 0x00,
         0x4b, 0x00, 0x00, 0x00, 0x3d, 0x00, 0x04, 0x00, 0x1d, 0x00, 0x00, 0x00,
         0x4d, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x91, 0x00, 0x05, 0x00,
         0x1d, 0x00, 0x00, 0x00, 0x4e, 0x00, 0x00, 0x00, 0x4c, 0x00, 0x00, 0x00,
         0x4d, 0x00, 0x00, 0x00, 0x41, 0x00, 0x05, 0x00, 0x32, 0x00, 0x00, 0x00,
         0x4f, 0x00, 0x00, 0x00, 0x45, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00,
         0x3e, 0x00, 0x03, 0x00, 0x4f, 0x00, 0x00, 0x00, 0x4e, 0x00, 0x00, 0x00,
         0xfd, 0x00, 0x01, 0x00, 0x38, 0x00, 0x01, 0x00
      };

      static const uint8_t g_fragmentShaderCode[] = {
         0x03, 0x02, 0x23, 0x07, 0x00, 0x00, 0x01, 0x00, 0x06, 0x00, 0x08, 0x00,
         0x0d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x00, 0x02, 0x00,
         0x01, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x06, 0x00, 0x01, 0x00, 0x00, 0x00,
         0x47, 0x4c, 0x53, 0x4c, 0x2e, 0x73, 0x74, 0x64, 0x2e, 0x34, 0x35, 0x30,
         0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
         0x01, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x07, 0x00, 0x04, 0x00, 0x00, 0x00,
         0x04, 0x00, 0x00, 0x00, 0x6d, 0x61, 0x69, 0x6e, 0x00, 0x00, 0x00, 0x00,
         0x09, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x10, 0x00, 0x03, 0x00,
         0x04, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x03, 0x00, 0x03, 0x00,
         0x02, 0x00, 0x00, 0x00, 0x90, 0x01, 0x00, 0x00, 0x04, 0x00, 0x09, 0x00,
         0x47, 0x4c, 0x5f, 0x41, 0x52, 0x42, 0x5f, 0x73, 0x65, 0x70, 0x61, 0x72,
         0x61, 0x74, 0x65, 0x5f, 0x73, 0x68, 0x61, 0x64, 0x65, 0x72, 0x5f, 0x6f,
         0x62, 0x6a, 0x65, 0x63, 0x74, 0x73, 0x00, 0x00, 0x04, 0x00, 0x09, 0x00,
         0x47, 0x4c, 0x5f, 0x41, 0x52, 0x42, 0x5f, 0x73, 0x68, 0x61, 0x64, 0x69,
         0x6e, 0x67, 0x5f, 0x6c, 0x61, 0x6e, 0x67, 0x75, 0x61, 0x67, 0x65, 0x5f,
         0x34, 0x32, 0x30, 0x70, 0x61, 0x63, 0x6b, 0x00, 0x05, 0x00, 0x04, 0x00,
         0x04, 0x00, 0x00, 0x00, 0x6d, 0x61, 0x69, 0x6e, 0x00, 0x00, 0x00, 0x00,
         0x05, 0x00, 0x04, 0x00, 0x09, 0x00, 0x00, 0x00, 0x6f, 0x43, 0x6f, 0x6c,
         0x6f, 0x72, 0x00, 0x00, 0x05, 0x00, 0x04, 0x00, 0x0b, 0x00, 0x00, 0x00,
         0x76, 0x43, 0x6f, 0x6c, 0x6f, 0x72, 0x00, 0x00, 0x47, 0x00, 0x04, 0x00,
         0x09, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
         0x47, 0x00, 0x04, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x00,
         0x00, 0x00, 0x00, 0x00, 0x13, 0x00, 0x02, 0x00, 0x02, 0x00, 0x00, 0x00,
         0x21, 0x00, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
         0x16, 0x00, 0x03, 0x00, 0x06, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00,
         0x17, 0x00, 0x04, 0x00, 0x07, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00,
         0x04, 0x00, 0x00, 0x00, 0x20, 0x00, 0x04, 0x00, 0x08, 0x00, 0x00, 0x00,
         0x03, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x3b, 0x00, 0x04, 0x00,
         0x08, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
         0x20, 0x00, 0x04, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
         0x07, 0x00, 0x00, 0x00, 0x3b, 0x00, 0x04, 0x00, 0x0a, 0x00, 0x00, 0x00,
         0x0b, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x36, 0x00, 0x05, 0x00,
         0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
         0x03, 0x00, 0x00, 0x00, 0xf8, 0x00, 0x02, 0x00, 0x05, 0x00, 0x00, 0x00,
         0x3d, 0x00, 0x04, 0x00, 0x07, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
         0x0b, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x03, 0x00, 0x09, 0x00, 0x00, 0x00,
         0x0c, 0x00, 0x00, 0x00, 0xfd, 0x00, 0x01, 0x00, 0x38, 0x00, 0x01, 0x00
      };

      VkShaderModuleCreateInfo vertexShaderCreateInfo = {
         .sType = VK_STRUCTURE_TYPE_SHADER_MODULE_CREATE_INFO,
         .pNext = NULL,
         .flags = 0,
         .codeSize = sizeof(g_vertexShaderCode),
         .pCode = (const uint32_t *)g_vertexShaderCode,
      };

      VK_VERIFY(device->vkCreateShaderModule(device->device, &vertexShaderCreateInfo, NULL, &s_resources.vertexShader));

      VkShaderModuleCreateInfo fragmentShaderCreateInfo = {
         .sType = VK_STRUCTURE_TYPE_SHADER_MODULE_CREATE_INFO,
         .pNext = NULL,
         .flags = 0,
         .codeSize = sizeof(g_fragmentShaderCode),
         .pCode = (const uint32_t *)g_fragmentShaderCode,
      };

      VK_VERIFY(device->vkCreateShaderModule(device->device, &fragmentShaderCreateInfo, NULL, &s_resources.fragmentShader));

      VkPipelineShaderStageCreateInfo shaderStageCreateInfos[2] = {
         {
            .sType = VK_STRUCTURE_TYPE_PIPELINE_SHADER_STAGE_CREATE_INFO,
            .pNext = NULL,
            .flags = 0,
            .stage = VK_SHADER_STAGE_VERTEX_BIT,
            .module = s_resources.vertexShader,
            .pName = "main",
            .pSpecializationInfo = NULL,
         },
         {
            .sType = VK_STRUCTURE_TYPE_PIPELINE_SHADER_STAGE_CREATE_INFO,
            .pNext = NULL,
            .flags = 0,
            .stage = VK_SHADER_STAGE_FRAGMENT_BIT,
            .module = s_resources.fragmentShader,
            .pName = "main",
            .pSpecializationInfo = NULL,
         },
      };

      VkPipelineVertexInputStateCreateInfo vertexInputStateCreateInfo = {
         .sType = VK_STRUCTURE_TYPE_PIPELINE_VERTEX_INPUT_STATE_CREATE_INFO,
         .pNext = NULL,
         .flags = 0,
         .vertexBindingDescriptionCount = 0,
         .pVertexBindingDescriptions = NULL,
         .vertexAttributeDescriptionCount = 0,
         .pVertexAttributeDescriptions = NULL,
      };

      VkPipelineInputAssemblyStateCreateInfo inputAssemblyCreateInfo = {
         .sType = VK_STRUCTURE_TYPE_PIPELINE_INPUT_ASSEMBLY_STATE_CREATE_INFO,
         .pNext = NULL,
         .flags = 0,
         .topology = VK_PRIMITIVE_TOPOLOGY_TRIANGLE_LIST,
         .primitiveRestartEnable = VK_FALSE,
      };

      VkViewport viewport = {
         .x = 0.0f,
         .y = 0.0f,
         .width = (float) device->surfaceWidth,
         .height = (float) device->surfaceHeight,
         .minDepth = 0.0f,
         .maxDepth = 1.0f,
      };

      VkRect2D backBufferRect = {
         .offset = {
            .x = 0,
            .y = 0,
          },
         .extent = {
            .width = device->surfaceWidth,
            .height = device->surfaceHeight,
          },
      };

      VkPipelineViewportStateCreateInfo viewportStateCreateInfo = {
         .sType = VK_STRUCTURE_TYPE_PIPELINE_VIEWPORT_STATE_CREATE_INFO,
         .pNext = NULL,
         .flags = 0,
         .viewportCount = 1,
         .pViewports = &viewport,
         .scissorCount = 1,
         .pScissors = &backBufferRect,
      };

      VkPipelineRasterizationStateCreateInfo rasterStateCreateInfo = {
         .sType = VK_STRUCTURE_TYPE_PIPELINE_RASTERIZATION_STATE_CREATE_INFO,
         .pNext = NULL,
         .flags = 0,
         .depthClampEnable = VK_FALSE,
         .rasterizerDiscardEnable = VK_FALSE,
         .polygonMode = VK_POLYGON_MODE_FILL,
         .cullMode = VK_CULL_MODE_BACK_BIT,
         .frontFace = VK_FRONT_FACE_CLOCKWISE,
         .depthBiasEnable = VK_FALSE,
         .depthBiasConstantFactor = 0.0f,
         .depthBiasClamp = 0.0f,
         .depthBiasSlopeFactor = 0.0f,
         .lineWidth = 1.0f,
      };

      VkPipelineMultisampleStateCreateInfo multisampleStateCreateInfo = {
         .sType = VK_STRUCTURE_TYPE_PIPELINE_MULTISAMPLE_STATE_CREATE_INFO,
         .pNext = NULL,
         .flags = 0,
         .rasterizationSamples = VK_SAMPLE_COUNT_1_BIT,
         .sampleShadingEnable = VK_FALSE,
         .minSampleShading = 0.0f,
         .pSampleMask = NULL,
         .alphaToCoverageEnable = VK_FALSE,
         .alphaToOneEnable = VK_FALSE,
      };

      VkPipelineDepthStencilStateCreateInfo dsStateCreateInfo = {
         .sType = VK_STRUCTURE_TYPE_PIPELINE_DEPTH_STENCIL_STATE_CREATE_INFO,
         .pNext = NULL,
         .flags = 0,
         .depthTestEnable = VK_FALSE,
         .depthWriteEnable = VK_FALSE,
         .depthCompareOp = VK_COMPARE_OP_ALWAYS,
         .depthBoundsTestEnable = VK_FALSE,
         .stencilTestEnable = VK_FALSE,
         .front = {
            .failOp = VK_STENCIL_OP_KEEP,
            .passOp = VK_STENCIL_OP_KEEP,
            .depthFailOp = VK_STENCIL_OP_KEEP,
            .compareOp = VK_COMPARE_OP_ALWAYS,
            .compareMask = 0,
            .writeMask = 0,
            .reference = 0,
         },
         .back = {
            .failOp = VK_STENCIL_OP_KEEP,
            .passOp = VK_STENCIL_OP_KEEP,
            .depthFailOp = VK_STENCIL_OP_KEEP,
            .compareOp = VK_COMPARE_OP_ALWAYS,
            .compareMask = 0,
            .writeMask = 0,
            .reference = 0,
         },
         .minDepthBounds = 0.0f,
         .maxDepthBounds = 1.0f,
      };

      VkPipelineColorBlendAttachmentState blendAttachState = {
         .blendEnable = VK_FALSE,
         .srcColorBlendFactor = VK_BLEND_FACTOR_ONE,
         .dstColorBlendFactor = VK_BLEND_FACTOR_ONE_MINUS_SRC_ALPHA,
         .colorBlendOp = VK_BLEND_OP_ADD,
         .srcAlphaBlendFactor = VK_BLEND_FACTOR_ONE,
         .dstAlphaBlendFactor = VK_BLEND_FACTOR_ONE_MINUS_SRC_ALPHA,
         .alphaBlendOp = VK_BLEND_OP_ADD,
         .colorWriteMask = VK_COLOR_COMPONENT_R_BIT | VK_COLOR_COMPONENT_G_BIT | VK_COLOR_COMPONENT_B_BIT | VK_COLOR_COMPONENT_A_BIT,
      };

      VkPipelineColorBlendStateCreateInfo blendStateCreateInfo = {
         .sType = VK_STRUCTURE_TYPE_PIPELINE_COLOR_BLEND_STATE_CREATE_INFO,
         .pNext = NULL,
         .flags = 0,
         .logicOpEnable = VK_FALSE,
         .logicOp = VK_LOGIC_OP_CLEAR,
         .attachmentCount = 1,
         .pAttachments = &blendAttachState,
         .blendConstants = { 0.0f, 0.0f, 0.0f, 0.0f },
      };

      VkPushConstantRange pushConstants = {
         .stageFlags = VK_SHADER_STAGE_VERTEX_BIT,
         .offset = 0,
         .size = sizeof(ShaderMatrices),
      };

      VkPipelineLayoutCreateInfo pipelineLayoutCreateInfo = {
         .sType = VK_STRUCTURE_TYPE_PIPELINE_LAYOUT_CREATE_INFO,
         .pNext = NULL,
         .flags = 0,
         .setLayoutCount = 0,
         .pSetLayouts = NULL,
         .pushConstantRangeCount = 1,
         .pPushConstantRanges = &pushConstants,
      };

      VK_VERIFY(device->vkCreatePipelineLayout(device->device, &pipelineLayoutCreateInfo, NULL, &s_resources.pipelineLayout));

      VkGraphicsPipelineCreateInfo pipelineCreateInfo = {
         .sType = VK_STRUCTURE_TYPE_GRAPHICS_PIPELINE_CREATE_INFO,
         .pNext = NULL,
         .flags = 0,
         .stageCount = ARRAY_COUNT(shaderStageCreateInfos),
         .pStages = shaderStageCreateInfos,
         .pVertexInputState = &vertexInputStateCreateInfo,
         .pInputAssemblyState = &inputAssemblyCreateInfo,
         .pTessellationState = NULL,
         .pViewportState = &viewportStateCreateInfo,
         .pRasterizationState = &rasterStateCreateInfo,
         .pMultisampleState = &multisampleStateCreateInfo,
         .pDepthStencilState = &dsStateCreateInfo,
         .pColorBlendState = &blendStateCreateInfo,
         .pDynamicState = NULL,
         .layout = s_resources.pipelineLayout,
         .renderPass = s_resources.renderPass,
         .subpass = 0,
         .basePipelineHandle = VK_NULL_HANDLE,
         .basePipelineIndex = -1,
      };

      VK_VERIFY(device->vkCreateGraphicsPipelines(device->device, VK_NULL_HANDLE, 1, &pipelineCreateInfo, NULL, &s_resources.pipeline));
   }

   return 1;
}

void UninitResources(const VulkanDevice *device)
{
   VK_VERIFY(device->vkDeviceWaitIdle(device->device));

   device->vkDestroyPipeline(device->device, s_resources.pipeline, NULL);
   s_resources.pipeline = VK_NULL_HANDLE;
   device->vkDestroyPipelineLayout(device->device, s_resources.pipelineLayout, NULL);
   s_resources.pipelineLayout = VK_NULL_HANDLE;
   device->vkDestroyShaderModule(device->device, s_resources.fragmentShader, NULL);
   s_resources.fragmentShader = VK_NULL_HANDLE;
   device->vkDestroyShaderModule(device->device, s_resources.vertexShader, NULL);
   s_resources.vertexShader = VK_NULL_HANDLE;

   for (uint32_t i = 0; i < device->swapchainImageCount; ++i) {
      device->vkDestroyImageView(device->device, s_resources.framebuffers[i].view, NULL);
      device->vkDestroyFramebuffer(device->device, s_resources.framebuffers[i].framebuffer, NULL);
   }
   free(s_resources.framebuffers);
   s_resources.framebuffers = NULL;

   device->vkDestroyRenderPass(device->device, s_resources.renderPass, NULL);
   s_resources.renderPass = VK_NULL_HANDLE;
}

int DrawFrame(const VulkanDevice *device, float dt)
{
   VkRect2D backBufferRect = {
      .offset = {
         .x = 0,
         .y = 0,
      },
      .extent = {
         .width = device->surfaceWidth,
         .height = device->surfaceHeight,
      },
   };

   uint32_t curFrame = s_frameNum++ % ARRAY_COUNT(device->frames);
   VK_VERIFY(device->vkWaitForFences(device->device, 1, &device->frames[curFrame].frameComplete, VK_TRUE, UINT64_MAX));
   VK_VERIFY(device->vkResetFences(device->device, 1, &device->frames[curFrame].frameComplete));

   VkFence nullFence = VK_NULL_HANDLE;
   uint32_t imageIdx;
   VkResult result = device->vkAcquireNextImageKHR(device->device, device->swapchain, UINT64_MAX,
      device->frames[curFrame].imageAcquired, nullFence, &imageIdx);
   if (result == VK_ERROR_OUT_OF_DATE_KHR) {
      return 0;
   }
   ASSERT(result == VK_SUCCESS);

   VkCommandBuffer commandBuffer = device->frames[curFrame].commandBuffer;

   VkCommandBufferBeginInfo beginInfo = {
      .sType = VK_STRUCTURE_TYPE_COMMAND_BUFFER_BEGIN_INFO,
      .pNext = NULL,
      .flags = VK_COMMAND_BUFFER_USAGE_ONE_TIME_SUBMIT_BIT,
      .pInheritanceInfo = NULL,
   };

   VK_VERIFY(device->vkBeginCommandBuffer(commandBuffer, &beginInfo));

   VkClearValue clearValue = {
      .color.float32 = { 0.086f, 0.086f, 0.1137f, 1.0f, },
   };
   VkRenderPassBeginInfo passInfo = {
      .sType = VK_STRUCTURE_TYPE_RENDER_PASS_BEGIN_INFO,
      .pNext = NULL,
      .renderPass = s_resources.renderPass,
      .framebuffer = s_resources.framebuffers[imageIdx].framebuffer,
      .renderArea = backBufferRect,
      .clearValueCount = 1,
      .pClearValues = &clearValue,
   };
   device->vkCmdBeginRenderPass(commandBuffer, &passInfo, VK_SUBPASS_CONTENTS_INLINE);

   device->vkCmdBindPipeline(commandBuffer, VK_PIPELINE_BIND_POINT_GRAPHICS, s_resources.pipeline);

   s_cubeRot += dt * CUBE_SPIN_SPEED;
   s_cubeRot -= floorf(s_cubeRot);

   ShaderMatrices matrices;
   Mat4 worldFromLocal, viewFromWorld, viewFromLocal, clipFromView;
   mat4RotY(&worldFromLocal, s_cubeRot * (2.0f * PI));

   Vec3 eye = { 0.0f, 1.5f, -3.0f };
   Vec3 target = { 0.0f, 0.0f, 0.0f };
   Vec3 up = { 0.0f, 1.0f, 0.0f };
   mat4LookAt(&viewFromWorld, eye, target, up);
   mat4Mul(&viewFromLocal, &viewFromWorld, &worldFromLocal);

   mat4PerspectiveFov(&clipFromView, PI / 2.0f, device->surfaceWidth / (float)device->surfaceHeight, 1.0f, 100.0f);
   mat4Mul(&matrices.clipFromLocal, &clipFromView, &viewFromLocal);

   device->vkCmdPushConstants(commandBuffer, s_resources.pipelineLayout, VK_SHADER_STAGE_VERTEX_BIT, 0, sizeof(matrices), &matrices);

   device->vkCmdDraw(commandBuffer, 36, 1, 0, 0);

   device->vkCmdEndRenderPass(commandBuffer);
   VK_VERIFY(device->vkEndCommandBuffer(commandBuffer));

   VkPipelineStageFlags stageFlags = VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT;
   VkSubmitInfo submitInfo = {
      .sType = VK_STRUCTURE_TYPE_SUBMIT_INFO,
      .pNext = NULL,
      .waitSemaphoreCount = 1,
      .pWaitSemaphores = &device->frames[curFrame].imageAcquired,
      .pWaitDstStageMask = &stageFlags,
      .commandBufferCount = 1,
      .pCommandBuffers = &commandBuffer,
      .signalSemaphoreCount = 1,
      .pSignalSemaphores = &device->frames[curFrame].drawComplete,
   };

   VK_VERIFY(device->vkQueueSubmit(device->queue, 1, &submitInfo, device->frames[curFrame].frameComplete));

   VkResult presentResult;
   VkPresentInfoKHR presentInfo = { 
      .sType = VK_STRUCTURE_TYPE_PRESENT_INFO_KHR,
      .pNext = NULL,
      .waitSemaphoreCount = 1,
      .pWaitSemaphores = &device->frames[curFrame].drawComplete,
      .swapchainCount = 1,
      .pSwapchains = &device->swapchain,
      .pImageIndices = &imageIdx,
      .pResults = &presentResult,
   };

   VK_VERIFY(device->vkQueuePresentKHR(device->queue, &presentInfo));
   VK_VERIFY(presentResult);

   return 1;
}
